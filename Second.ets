// Second.ets

import { BusinessError } from '@kit.BasicServicesKit';
import { router } from '@kit.ArkUI';
import hilog from '@ohos.hilog';

interface Dish {
  id: number;
  name: string;
  price: number;
  desc: string;
  count: number;
  materials?: string; // æ–°å¢å­—æ®µï¼šä½¿ç”¨ææ–™
  origin?: string; // æ–°å¢å­—æ®µï¼šæ¥æºåœ°
}

interface RouterParams {
  dishes?: string;
}

interface OrderNavigateParams {
  dishes: string;
  total: number;
}

@Entry
@Component
struct SecondPage {
  @State dishes: Array<Dish> = [];
  @State isProcessing: boolean = false;
  @State totalPrice: string = "0.00"; // ğŸ‘ˆ æ–°å¢çŠ¶æ€å˜é‡

  // åˆ é™¤äº†åŸæ¥çš„ get totalPrice() æ–¹æ³•

  aboutToAppear() {
    const rawParams = router.getParams();
    let dishesParamValue: string | null = null;

    if (rawParams != null) {
      const params = rawParams as RouterParams;
      if (typeof params.dishes === 'string') {
        dishesParamValue = params.dishes;
      }
    }

    const defaultDishes: Dish[] = [
      {
        id: 1001,
        name: 'å®«ä¿é¸¡ä¸',
        price: 42,
        desc: 'ä¼ ç»Ÿå·èœï¼Œé¸¡ä¸é²œå«©é…åˆèŠ±ç”Ÿç±³çš„é¦™è„†',
        count: 0
      },
      {
        id: 2003,
        name: 'æ¸…ç‚’æ—¶è”¬',
        price: 28,
        desc: 'æ—¶ä»¤è”¬èœæ¸…ç‚’ï¼Œä¿ç•™é£ŸæåŸå‘³',
        count: 0
      }
    ];

    if (dishesParamValue !== null) {
      try {
        this.dishes = JSON.parse(dishesParamValue);
        hilog.info(0x0000, 'SecondPage', 'Dishes initialized from params');
      } catch (error) {
        hilog.error(0x0000, 'SecondPage', `Parse error: ${(error as Error).message}`);
        this.dishes = defaultDishes;
      }
    } else {
      this.dishes = defaultDishes;
    }

    // ğŸ‘‡ åˆå§‹åŒ–æ€»ä»·
    this.calculateTotalPrice();
  }

  // ğŸ‘‡ æ–°å¢ï¼šè®¡ç®—æ€»ä»·å¹¶æ›´æ–°çŠ¶æ€
  private calculateTotalPrice() {
    let total = 0;
    for (let i = 0; i < this.dishes.length; i++) {
      const d = this.dishes[i];
      const price = Number(d.price);
      const count = Number(d.count);
      if (!isNaN(price) && !isNaN(count) && count > 0) {
        total += price * count;
      }
    }
    this.totalPrice = total.toFixed(2);
  }

  build() {
    Column() {
      List({ space: 12 }) {
        ForEach(this.dishes, (item: Dish) => {
          ListItem() {
            this.buildDishItem(item)
          }
          .id(item.id.toString())
        })
      }
      .layoutWeight(1)
      .divider({ strokeWidth: 1, color: '#eee' })

      this.buildOrderFooter()
    }
    .padding(12)
    .backgroundColor('#F5F5F5')
  }

  @Builder
  private buildDishItem(item: Dish) {
    Row() {
      // ğŸ‘ˆ å·¦ä¾§ï¼šå¯ç‚¹å‡»è·³è½¬è¯¦æƒ…
      Column() {
        Text(item.name)
          .fontSize(18)
          .fontColor('#333')
        Text(item.desc)
          .fontSize(12)
          .fontColor('#666')
          .margin({ top: 4 })
      }
      .layoutWeight(1)
      .onClick(() => {
        // âœ… ä»…å·¦ä¾§åŒºåŸŸç‚¹å‡»è·³è½¬è¯¦æƒ…
        router.pushUrl({
          url: 'pages/DishDetail',
          params: {
            dish: JSON.stringify(item)
          }
        });
      })

      // å³ä¾§ï¼šæ•°é‡æ§åˆ¶ï¼ˆä¸å¹²æ‰°è·³è½¬ï¼‰
      Row() {
        Text('-')
          .fontSize(24)
          .fontColor('#666')
          .onClick(() => {
            this.updateCount(item.id, -1);
          })

        Text(item.count.toString())
          .width(40)
          .textAlign(TextAlign.Center)
          .fontSize(16)
        Text('+')
          .fontSize(24)
          .fontColor('#666')
          .onClick(() => {
            this.updateCount(item.id, 1);
          })
      }
      .padding(8)
      .borderRadius(20)
      .backgroundColor('#FFF')
    }
    .padding(12)
    .backgroundColor('#FFF')
    .borderRadius(8)
  }

  @Builder
  private buildOrderFooter() {
    Column() {
      Row() {
        Text('åˆè®¡ï¼š')
          .fontSize(16)
        // ğŸ‘‡ ç›´æ¥ä½¿ç”¨ @State å˜é‡
        Text(`ï¿¥${this.totalPrice}`)
          .fontSize(18)
          .fontColor('#FF4500')
      }
      .justifyContent(FlexAlign.SpaceBetween)
      .width('100%')
      .padding({ bottom: 12 })

      Button('æäº¤è®¢å•')
        .type(ButtonType.Capsule)
        .width('100%')
        .height(40)
        .backgroundColor('#FF4500')
        .onClick(() => this.submitOrder())
        .enabled(!this.isProcessing)
    }
    .padding(12)
    .backgroundColor('#FFF')
    .borderRadius(8)
    .shadow({
      radius: 4,
      color: '#10000000',
      offsetX: 0,
      offsetY: 2
    })
  }

  private updateCount(id: number, delta: number) {
    const newDishes = this.dishes.map(item => {
      if (item.id === id) {
        const newCount = Math.max(0, Number(item.count) + delta);
        return {
          id: item.id,
          name: item.name,
          price: item.price,
          desc: item.desc,
          count: newCount
        } as Dish;
      }
      return {
        id: item.id,
        name: item.name,
        price: item.price,
        desc: item.desc,
        count: item.count
      } as Dish;
    });

    this.dishes = newDishes;
    this.calculateTotalPrice(); // ğŸ‘ˆ å…³é”®ï¼šæ›´æ–°æ€»ä»·
    hilog.info(0x0000, 'SecondPage', `Updated dish ${id}, new dishes: ${JSON.stringify(newDishes)}`);
  }

  private async submitOrder() {
    if (this.isProcessing) {
      return;
    }
    this.isProcessing = true;

    try {
      const selected = this.dishes.filter(dish => dish.count > 0);
      if (selected.length === 0) {
        throw new Error('æœªé€‰æ‹©ä»»ä½•èœå“');
      }

      const params: OrderNavigateParams = {
        dishes: JSON.stringify(selected),
        total: parseFloat(this.totalPrice) // ğŸ‘ˆ ç°åœ¨æ˜¯å­—ç¬¦ä¸²ï¼Œå¯æ­£å¸¸è§£æ
      };

      await router.pushUrl({
        url: 'pages/Third',
        params: params
      });
    } catch (err) {
      const message = (err as Error).message || 'æœªçŸ¥é”™è¯¯';
      hilog.error(0x0000, 'SecondPage', `æäº¤å¤±è´¥: ${message}`);
    } finally {
      this.isProcessing = false;
    }
  }
}