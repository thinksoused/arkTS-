// Third.ets

import { BusinessError } from '@kit.BasicServicesKit';
import { router } from '@kit.ArkUI';
import hilog from '@ohos.hilog';

interface Dish {
  id: number;
  name: string;
  price: number;
  desc: string;
  count: number;
}

interface ThirdPageParams {
  dishes?: string;
  total?: number;
}

@Entry
@Component
struct Third {
  @State total: number = 0;
  @State dishes: Array<Dish> = [];
  @State isProcessing: boolean = false;

  aboutToAppear() {
    const rawParams = router.getParams();
    if (rawParams == null) return;

    const params = rawParams as ThirdPageParams;

    if (typeof params.dishes === 'string') {
      try {
        this.dishes = JSON.parse(params.dishes);
      } catch (e) {
        hilog.error(0x0000, 'ThirdPage', 'Failed to parse dishes');
        this.dishes = [];
      }
    }

    if (typeof params.total === 'number') {
      this.total = params.total;
    }
  }

  build() {
    Column() {
      Text('ç¡®è®¤è®¢å•')
        .fontSize(28)
        .fontWeight(FontWeight.Bold)
        .margin({ top: 40 })

      // èœå“åˆ—è¡¨
      Column() {
        ForEach(this.dishes, (dish: Dish) => {
          if (dish.count > 0) {
            Row() {
              Text(`${dish.name} Ã— ${dish.count}`)
                .fontColor('#333')
                .layoutWeight(1)
              Text(`ï¿¥${(dish.price * dish.count).toFixed(2)}`)
                .fontColor('#666')
            }
            .width('100%')
            .padding({ top: 10, bottom: 10 })
          }
        })
      }
      .width('80%')
      .margin({ top: 30 })
      .padding({ top: 16, bottom: 16, left: 12, right: 12 })
      .backgroundColor('#F9F9F9')
      .borderRadius(8)

      // åˆè®¡
      Row() {
        Text('åˆè®¡ï¼š')
          .fontSize(18)
        Text(`ï¿¥${this.total.toFixed(2)}`)
          .fontSize(20)
          .fontColor('#FF4500')
          .fontWeight(FontWeight.Bold)
      }
      .width('80%')
      .justifyContent(FlexAlign.SpaceBetween)
      .margin({ top: 20 })

      // æŒ‰é’®
      Button('ç¡®è®¤æ”¯ä»˜')
        .type(ButtonType.Capsule)
        .width('80%')
        .height(50)
        .backgroundColor('#FF4500')
        .fontColor('#FFFFFF')
        .fontSize(18)
        .margin({ top: 40 })
        .enabled(!this.isProcessing)
        .onClick(() => {
          if (this.isProcessing) return;
          this.isProcessing = true;

          // æ¨¡æ‹Ÿæ”¯ä»˜åŽè·³è½¬åˆ°æ”¯ä»˜æˆåŠŸé¡µ
          setTimeout(() => {
            this.isProcessing = false;
            router.pushUrl({
              url: 'pages/Fourth', // ðŸ‘ˆ è·³è½¬åˆ°ç¬¬å››é¡µ
              params: {
                dishes: JSON.stringify(this.dishes),
                total: this.total
              }
            });
          }, 600);
        })

      Button('è¿”å›žä¿®æ”¹')
        .type(ButtonType.Capsule)
        .width('80%')
        .height(50)
        .backgroundColor('#F5F5F5')
        .fontColor('#333')
        .fontSize(18)
        .margin({ top: 16 })
        .onClick(() => {
          router.back(); // å›žåˆ° Second.ets
        })
    }
    .width('100%')
    .height('100%')
    .padding(20)
    .backgroundColor('#FFF')
  }
}